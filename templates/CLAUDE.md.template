# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## ⚠️ Before You Do Anything

**STOP. Read this first.**

1. **Check git status**: `git status && git log --oneline -5`
2. **Check current branch**: Are you on the right branch?
3. **Check for open PRs**: `gh pr list`
4. **Check for open issues**: `gh issue list`
5. **Read the roadmap**: See `DEVELOPMENT_STRATEGY.md` for current priorities

If continuing work from a previous session:
- Pull latest: `git pull origin <branch-name>`
- Verify what's already done vs. what's pending
- Don't redo completed work

## Development Workflow

### Before Starting a New Task

1. **Check `gh issue list`** for assigned or relevant issues
2. **Check `DEVELOPMENT_STRATEGY.md`** for the current phase and priorities
3. **Check "Open Questions"** section - if your task has unresolved product/UX decisions:
   - **Ask the user proactively** before implementing
   - Use exploratory questions to clarify requirements
   - Don't assume - get explicit answers
4. **Only then** start implementation

### During Implementation

1. Make changes, commit frequently with clear messages
2. Push after each logical commit
3. When complete: `gh pr create`

### After PR Created

**Wait for approval.** The human owner must review and approve before merge.

**You MUST:**
- Add a PR comment with your role in the headline when you contribute
- Roles: **Chief Architect**, **Staff Developer**, **DevOps/BuildEng**, **ReqsEng**, **TestEng**
- If you don't know your role, ask the user before commenting
- Format: `## [Role Name]\n\n<summary of what you did>`
- Use `gh pr comment <number> --body "## Staff Developer\n\n<summary>"`

**You do NOT:**
- Merge PRs yourself
- Delete branches
- Assume approval - always wait for explicit sign-off

**Chief Architect role (when assigned to a Claude agent):**
- May review PRs and recommend merge after verifying:
  1. CI checks have passed (build, tests, lint)
  2. Code review feedback has been addressed
- Must ask the human: "CI passed and review looks good. Ready to merge?"
- Must wait for human confirmation before any merge happens

**You CAN:**
- Start independent work on a new branch while waiting (ask first)

## Role Handoff Protocol

Each role must prompt the user with the next role after completing their work.

### Workflow Sequence

```
┌─────────┐    ┌──────────┐    ┌──────────┐    ┌────────────────────┐
│  Dev    │───▶│ TestEng  │───▶│ BuildEng │───▶│    Architect       │
│         │    │          │    │          │    │  (E2E + Logic)     │
└─────────┘    └──────────┘    └──────────┘    └────────────────────┘
     ▲              │                │                   │
     └──────────────┴────────────────┴───────────────────┘
                    "Needs changes" → back to Dev
```

### Role Responsibilities

| Role | Focus | Reviews For |
|------|-------|-------------|
| **Staff Dev** | Implementation | — |
| **TestEng** | Test coverage | Missing tests, edge cases, test quality |
| **BuildEng** | CI/CD health | Build passes, tests pass, lint clean |
| **Architect** | **End-to-end** | Logic correctness, architectural fit, no regressions, feature completeness |

### Role Definitions

**Staff Developer:**
Owns implementation. Familiarize deeply with CLAUDE.md, all process/strategy/decision/UX guidance files, architecture docs, and the codebase. You drive development forward, write code, create PRs.

**TestEng:**
Reviews test coverage and quality. Verify edge cases are covered, tests are meaningful (not just checking "truthy"), and the test strategy is sound.

**BuildEng:**
Ensures CI/CD health. Verify build passes, tests pass, lint is clean. Flag infrastructure issues or flaky tests.

**Chief Architect:**
Senior reviewer with end-to-end perspective. Familiarize deeply with repo, instructions, architecture, codebase. Reviews PRs for logic correctness, architectural fit, no regressions, feature completeness. Recommends merge after verification.

**ReqsEng:**
Defines requirements. Clarifies user needs, writes acceptance criteria, resolves ambiguity before development starts. Use the AskUserQuestion tool iteratively to discuss and refine requirements with the user.

### Handoff Prompts

After completing your work, end your message with the appropriate prompt:

| Your Role | Happy Path | Feedback Loop |
|-----------|------------|---------------|
| **Staff Dev** | "→ Invoke **TestEng** to review PR #X" | *(receives feedback, fixes, re-submits)* |
| **TestEng** | "→ Invoke **BuildEng** to verify CI on PR #X" | "→ Back to **Dev**: [test gaps]" |
| **BuildEng** | "→ Invoke **Architect** for E2E review of PR #X" | "→ Back to **Dev**: [CI failures]" |
| **Architect** | "E2E verified. Ready to merge PR #X?" | "→ Back to **Dev**: [logic/arch concern]" |
| **ReqsEng** | "Requirements ready. → Invoke **Dev** to implement" | — |

### Architect E2E Review Checklist

When reviewing, Architect verifies:
- [ ] **Logic correctness** — Does feature work as intended?
- [ ] **No regressions** — Existing functionality intact?
- [ ] **Architectural fit** — Follows patterns in ARCHITECTURE.md?
- [ ] **Feature complete** — Matches requirements/issue description?
- [ ] **CI green** — Tests + build + lint all pass?

### Example Flow

**Dev completes implementation:**
> Implemented task scheduling feature with tests.
>
> **→ Invoke TestEng to review PR #42**

**TestEng reviews:**
> Test coverage looks good. Minor suggestion: add edge case for midnight boundary.
>
> **→ Invoke BuildEng to verify CI on PR #42**

**BuildEng verifies:**
> CI passing: build ✓, tests ✓, lint ✓
>
> **→ Invoke Architect for E2E review of PR #42**

**Architect reviews:**
> E2E verified. Logic correct, no regressions, fits architecture.
>
> **Ready to merge PR #42?**

*(Human confirms, merge happens)*

## Project Overview

<!-- CUSTOMIZE: Replace this section with your project description -->

{{PROJECT_NAME}} is a **{{PROJECT_TYPE}}** that {{PROJECT_DESCRIPTION}}. See `DEVELOPMENT_STRATEGY.md` for the full vision and phased roadmap.

**Current Phase:** {{CURRENT_PHASE}} - See `DEVELOPMENT_STRATEGY.md` for details.

## Build Commands

<!-- CUSTOMIZE: Replace with your project's build commands -->

```bash
# Build the project
{{BUILD_COMMAND}}

# Run tests
{{TEST_COMMAND}}

# Clean build
{{CLEAN_COMMAND}}
```

## Before Pushing

**Always verify before `git push`:**

```bash
# 1. Build passes
{{BUILD_COMMAND}}

# 2. Tests pass
{{TEST_COMMAND}}

# 3. Lint is clean (or only pre-existing violations)
{{LINT_COMMAND}}
```

CI will run these checks on every PR. Fix failures locally before pushing.

## Architecture

<!-- CUSTOMIZE: Replace with your tech stack -->

- **{{UI_FRAMEWORK}}** for UI layer
- **{{DATA_LAYER}}** for data management
- **{{ARCHITECTURE_PATTERN}}** pattern

## Git Branching Strategy

### For Claude Agents (Remote/Web Sessions)

You will be assigned a branch like `claude/<description>-<sessionId>`. Rules:

1. **Check if branch exists and has work**: `git fetch origin && git log origin/main..origin/<your-branch> --oneline`
2. **If branch has commits ahead of main**: That's previous work. Don't redo it.
3. **If PR exists for this branch**: Check its status with `gh pr view <branch>`
4. **One commit = one logical change**: Don't bundle unrelated changes
5. **Push frequently**: `git push -u origin <branch-name>` after each commit
6. **Create PR when work is complete**: Use `gh pr create`

**Handoff Protocol** (when session ends or context switches):
- Commit all work in progress
- Push to remote
- Update `DEVELOPMENT_STRATEGY.md` "Current Status" section if needed
- Leave clear commit messages describing what was done

### For Human Developers

### Branch Types

| Branch Type | Pattern | Purpose | Merges To |
|-------------|---------|---------|-----------|
| **main** | `main` | Production-ready code, always stable | - |
| **feature** | `feature/<description>` | New features and enhancements | `main` |
| **bugfix** | `bugfix/<description>` | Bug fixes for issues found in main | `main` |
| **hotfix** | `hotfix/<description>` | Critical production fixes (urgent) | `main` |
| **refactor** | `refactor/<description>` | Code refactoring without behavior change | `main` |
| **experiment** | `experiment/<description>` | Experimental work, may be discarded | - |

### Branch Naming Conventions

Use lowercase with hyphens. Be descriptive but concise:

```
feature/timeline-drag-drop
feature/recurring-event-dialog
bugfix/calendar-sync-issue
bugfix/requirements-review-fixes
hotfix/crash-on-launch
refactor/calendar-manager-cleanup
experiment/new-animation-system
```

### Workflow Rules

1. **Never commit directly to `main`** - All changes go through branches and PRs
2. **Keep branches short-lived** - Merge within days, not weeks
3. **One purpose per branch** - Don't mix features with unrelated fixes
4. **Delete branches after merge** - Keep the repository clean

### Creating a New Branch

```bash
# Always start from an up-to-date main
git checkout main
git pull origin main

# Create your branch
git checkout -b feature/your-feature-name
```

### Commit Message Format

```
<type>: <short description>

<optional body explaining what and why>
```

**Types:**
- `feat:` - New feature
- `fix:` - Bug fix
- `refactor:` - Code refactoring
- `docs:` - Documentation changes
- `style:` - Formatting, no code change
- `test:` - Adding or updating tests
- `chore:` - Maintenance tasks

**Examples:**
```
feat: Add drag-and-drop rescheduling to timeline view

fix: Resolve calendar sync failing on first launch

refactor: Extract event validation into separate service
```

### Pull Request Process

1. Push your branch to origin
2. Create PR via `gh pr create` with clear title and description
3. Ensure build passes
4. Merge to main (squash merge preferred for clean history)
5. Delete the remote branch after merge

### Quick Reference

```bash
# Start new feature
git checkout main && git pull && git checkout -b feature/name

# Start bugfix
git checkout main && git pull && git checkout -b bugfix/name

# Push and create PR
git push -u origin HEAD
gh pr create --title "feat: Description" --body "Details..."

# After PR merge, cleanup
git checkout main && git pull
git branch -d feature/name
```

## Code Style

<!-- CUSTOMIZE: Replace with your language-specific guidelines -->

- Follow {{LANGUAGE}} API Design Guidelines
- Use {{FRAMEWORK}}'s declarative patterns
- Prefer composition over inheritance
- Keep views/components small and focused

## Code Quality

<!-- CUSTOMIZE: Replace with your linter configuration -->

{{LINTER_NAME}} enforces code standards. Run before committing:

```bash
{{LINT_COMMAND}}          # Check for violations
{{LINT_FIX_COMMAND}}      # Auto-fix what's possible
```

Configuration in `{{LINTER_CONFIG_FILE}}`.

## Working Style (User Preferences)

**⚠️ CRITICAL: ONE BRANCH/PR AT A TIME**
- **NEVER** create a second branch or PR without explicitly asking the user first
- If work exists on a branch, push to that branch - don't create a new one
- Check `gh pr list` before any branch operations

**Collaboration Pattern:**
- Commit frequently (after each logical change)
- Ask before major UX/product decisions - don't assume
- Update `DEVELOPMENT_STRATEGY.md` as work completes
- During UX work: implement → show screenshot → iterate based on feedback
- Prefer extending existing code over creating new files
- YAGNI: implement only what's requested, avoid speculative features

**Communication:**
- Be concise, direct
- Show options when there are trade-offs
- When user says "perfect" or similar, task is done - don't over-elaborate

## Plan Mode Workflow

For non-trivial implementations, use Claude Code's plan mode:

1. Use `/plan` command to enter plan mode
2. Review/create a plan covering:
   - Context (related issues, dependencies)
   - Implementation steps with file locations
   - Decisions requiring approval
3. Get human approval before coding
4. Reference plan in commits if helpful

If the plan needs to change significantly during implementation, pause and get approval.

## Pre-Commit Quality Gates

Before committing, verify:

1. **Build passes** - Code compiles without errors
2. **Tests pass** - No regressions introduced
3. **Lint clean** - No new violations (or only pre-existing ones)
4. **No debug code** - Remove console.log, print statements, etc.

Run `./scripts/pre-commit-check.sh` if available.

## Key Documents

<!-- CUSTOMIZE: Replace with your project's documentation map -->

| Document | Purpose | When to Read |
|----------|---------|--------------|
| `CLAUDE.md` | This file. How to work in this repo. | Always (entry point) |
| `DEVELOPMENT_STRATEGY.md` | **Product roadmap**. Phases, tasks, decisions log. | Before starting any feature work |
| `ARCHITECTURE.md` | **Technical architecture**. Data models, patterns, services. | Before modifying code structure |
| GitHub Issues | **Bug/task tracking**. Use `gh issue list` | Before any bug fix work |

**Always check `DEVELOPMENT_STRATEGY.md` before starting new work.**
**Always check `ARCHITECTURE.md` before making architectural changes.**
**Always check `gh issue list` for open bugs and tasks.**

## Issue Tracking (GitHub Issues)

All bugs, features, and tasks are tracked in **GitHub Issues**. Do NOT use markdown files for issue tracking.

### Labels

| Label | Meaning |
|-------|---------|
| `bug` | Something isn't working |
| `enhancement` | New feature or request |
| `refactor` | Code refactoring |
| `ux` | User experience issue |
| `tech-debt` | Technical debt cleanup |
| `P0` | Critical - blocks release |
| `P1` | High priority - fix this sprint |
| `P2` | Medium priority - fix soon |
| `P3` | Low priority - nice to have |
| `triage` | Needs investigation |
| `in-progress` | Currently being worked on |
| `phase-1` | Phase 1 work |
| `phase-2` | Phase 2 work |
| `phase-3` | Phase 3 work |

### Quick Commands

```bash
# List open issues
gh issue list

# List bugs only
gh issue list --label "bug"

# View issue details
gh issue view 123

# Create new issue
gh issue create --title "Bug: X" --label "bug,P1" --body "Description..."

# Start working on issue
gh issue edit 123 --add-label "in-progress"

# Reference issue in commit (links but doesn't close)
git commit -m "fix: Resolve issue description (#123)"

# Auto-close issue when PR merges (use "fixes", "closes", or "resolves")
git commit -m "fix: Resolve issue description (fixes #123)"

# DON'T close manually - let PR merge handle it
# gh issue close 123  ← Requires architect approval
```

### Approval Requirements

**Requires Chief Architect approval:**
- Merging PRs
- Deleting branches
- Manually closing issues (`gh issue close`)
- Creating issues with labels other than `triage`

**You CAN do without approval:**
- Create issues with `triage` label (architect will review/relabel)
- Add labels to existing issues (e.g., `in-progress`)
- View and comment on issues

### Workflow

**When user reports something:**
1. Create a GitHub Issue immediately: `gh issue create --title "..." --label "triage"`
2. Continue with current task
3. Don't fix immediately unless user asks
4. Architect will review and relabel/prioritize

**When starting bug fix work:**
1. Check issue details: `gh issue view 123`
2. Mark in-progress: `gh issue edit 123 --add-label "in-progress"`
3. Reproduce, fix, test
4. Reference issue in commit: `fix: Description (fixes #123)`
5. Issue auto-closes when PR merges (architect approves the PR)
6. Remove `in-progress` label if not auto-closed: `gh issue edit 123 --remove-label "in-progress"`

**Bug squashing per phase:**
1. At phase start: `gh issue list --label "bug"` to review open bugs
2. Add phase label to selected issues: `gh issue edit 123 --add-label "phase-1"`
3. Fix as part of phase work
4. Issues close automatically via PR commits
